@model IEnumerable<Tiss_MindRadar.Models.TeamReportViewModel>

@{
    ViewBag.Title = "各隊伍選手明細";
    Layout = "~/Views/Shared/_MindRadarLayout.cshtml";
}

<h2 class="text-2xl font-bold text-center mb-6 text-gray-800">各隊伍選手明細</h2>

<form id="teamForm" method="post" action="@Url.Action("TeamReportData", "ReportRawData")">
    <div class="mb-4 flex items-center space-x-4">
        <div class="flex-1">
            <label for="teamSelect" class="block text-gray-700 font-bold mb-1">選擇隊伍：</label>
            @Html.DropDownList("teamId", ViewBag.Teams as SelectList, "請選擇隊伍", new { @class = "form-control", id = "teamSelect" })
        </div>
    </div>
</form>

@if (Model != null && Model.Any())
{
    <h3 class="text-xl font-bold text-center mt-6 text-gray-700">隊伍成員與分數</h3>
    <table class="min-w-full bg-white shadow-md rounded border border-gray-300 mt-4">
        <thead>
            <tr class="bg-gray-200 text-gray-600 uppercase text-lg leading-normal">
                <th class="py-3 px-6 text-left">選手</th>
                <th class="py-3 px-6 text-left">心理類別</th>
                <th class="py-3 px-6 text-left">分數</th>
                <th class="py-3 px-6 text-left">填答日期</th>
            </tr>
        </thead>
        <tbody>
            @{
                var groupedData = Model.GroupBy(m => new { m.UserName, m.SurveyDate }).ToList();
            }

            @foreach (var group in groupedData)
            {
                int rowSpanCount = group.Count();

                foreach (var (item, index) in group.Select((value, i) => (value, i)))
                {
                    <tr class="border-b border-gray-200">
                        @if (index == 0)
                        {
                            <td class="py-3 px-6 text-left font-bold" rowspan="@rowSpanCount">@item.UserName</td>
                        }
                        <td class="py-3 px-6 text-left">@item.Category</td>
                        <td class="py-3 px-6 text-left">@item.Score</td>
                        @if (index == 0)
                        {
                            <td class="py-3 px-6 text-left" rowspan="@rowSpanCount">@item.SurveyDate.Value.ToString("yyyy/MM/dd")</td>
                        }
                    </tr>
                }
            }
        </tbody>
    </table>
}

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const teamSelect = document.getElementById("teamSelect");
        const form = document.getElementById("teamForm");

        teamSelect.addEventListener("change", function () {
            form.submit();
        });
    });
</script>