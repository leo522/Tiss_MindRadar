@model IEnumerable<Tiss_MindRadar.Models.TeamRawDataViewModel>

@{
    ViewBag.Title = "隊伍成員分數";
    Layout = "~/Views/Shared/_MindRadarLayout.cshtml";
}

<h2 class="text-2xl font-bold text-center mb-6 text-gray-800">隊伍成員分數</h2>

<form id="teamForm" method="get" action="@Url.Action("GetMentalStateTeamRawData", "TeamRawData")">
    <div class="mb-4">
        <label for="teamSelect" class="block text-gray-700 font-bold mb-2">選擇隊伍：</label>
        @Html.DropDownList("teamId", ViewBag.Teams as SelectList, "請選擇隊伍", new { @class = "form-control", id = "teamSelect" })
    </div>

    <div class="mb-4">
        <label for="userSelect" class="block text-gray-700 font-bold mb-2">選擇選手：</label>
        <select id="userSelect" name="userId" class="form-control" disabled>
            <option value="" selected disabled>請先選擇隊伍</option>
        </select>
    </div>
</form>

@if (Model.Any())
{
    <h3 class="text-xl font-bold text-center mt-6 text-gray-700">選手分數資料</h3>
    <table class="min-w-full bg-white shadow-md rounded border border-gray-300 mt-4">
        <thead>
            <tr class="bg-gray-200 text-gray-600 uppercase text-lg leading-normal">
                <th class="py-3 px-6 text-left">選手</th>
                <th class="py-3 px-6 text-left">心理類別</th>
                <th class="py-3 px-6 text-left">分數</th>
                <th class="py-3 px-6 text-left">檢測日期</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr class="border-b border-gray-200">
                    <td class="py-3 px-6 text-left font-bold">@item.UserName</td>
                    <td class="py-3 px-6 text-left">@item.Category</td>
                    <td class="py-3 px-6 text-left">@item.Score</td>
                    <td class="py-3 px-6 text-left">@(item.SurveyDate.HasValue ? item.SurveyDate.Value.ToString("yyyy/MM/dd") : "-")</td>
                </tr>
            }
        </tbody>
    </table>
}

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const teamSelect = document.getElementById("teamSelect");
        const userSelect = document.getElementById("userSelect");
        const form = document.getElementById("teamForm");

        // 當選擇隊伍時，透過 AJAX 載入該隊伍的選手
        teamSelect.addEventListener("change", function () {
            userSelect.innerHTML = '<option value="" selected disabled>請選擇選手</option>'; // 清空選手選單
            userSelect.disabled = true;

            let teamId = this.value;
            if (!teamId) return;

            fetch(`/TeamRawData/GetUsersByTeam?teamId=${teamId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        userSelect.disabled = false;
                        data.forEach(user => {
                            let option = document.createElement("option");
                            option.value = user.UserID;
                            option.textContent = user.UserName;
                            userSelect.appendChild(option);
                        });
                    }
                })
                .catch(error => console.error("選手載入失敗:", error));
        });

        // 當選擇選手時，自動提交表單
        userSelect.addEventListener("change", function () {
            form.submit();
        });
    });
</script>
